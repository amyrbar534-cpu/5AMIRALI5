<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سامانه ارزیابی آزمایشگاه | نسخه نهایی</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* === متغیرهای CSS === */
        :root {
            --color-bg-primary: #1e1e1e;   
            --color-bg-secondary: #2a2a2a; 
            --color-text-light: #f0f0f0;   
            --color-text-muted: #aaaaaa;   
            --color-accent-blue: #007bff;  
            --color-accent-green: #2ecc71; 
            --color-danger: #e74c3c;       
            --color-warning: #f1c40f;      
            --color-border: #3c3c3c;       
            --color-info: #3498db;         
        }

        /* =================================
           CSS اصلی (دسکتاپ)
           ================================= */
        body { 
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--color-bg-primary); 
            color: var(--color-text-light);
            padding: 20px; 
            display: flex;
            justify-content: center;
            align-items: center; 
            min-height: 100vh;
            margin: 0;
            line-height: 1.6;
        }
        .container { 
            max-width: 700px; /* حداکثر عرض در دسکتاپ */
            width: 95%;
            background: var(--color-bg-secondary); 
            padding: 50px 40px; 
            border-radius: 20px; 
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7); 
            border-top: 5px solid var(--color-accent-blue);
            box-sizing: border-box;
        }
        h1 { 
            color: var(--color-accent-blue); 
            font-weight: 900; 
            font-size: 2.5em;
            margin-bottom: 25px;
            text-align: center;
        }
        
        /* === استایل اختصاصی برای صفحه خوش آمدگویی در مرکز === */
        #welcome-section {
            text-align: center; 
            display: flex;
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            min-height: 300px; 
        }
        #welcome-section p {
            max-width: 90%;
        }

        /* اطلاعات گروه و ورودی‌ها */
        .group-info { 
            background-color: var(--color-bg-primary);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 35px;
        }
        .group-info label {
            font-weight: 700;
            color: var(--color-text-light);
            display: block; 
            margin-bottom: 8px;
        }
        
        /* **تنظیمات فیلدهای ورودی (رفع مشکل سفید شدن)** */
        .group-info input[type="text"], .group-info textarea {
            width: 100%; 
            padding: 14px; 
            margin-top: 5px;
            background-color: #1a1a1a !important; 
            color: var(--color-text-light) !important; 
            border: 1px solid var(--color-border); 
            border-radius: 8px;
            box-sizing: border-box;
            resize: vertical; 
            
            /* جلوگیری از تغییر رنگ در زمان Autofill/Focus */
            -webkit-text-fill-color: var(--color-text-light) !important;
            -webkit-box-shadow: 0 0 0 1000px #1a1a1a inset !important;
            transition: background-color 5000s ease-in-out 0s;
        }
        
        .group-info textarea {
            min-height: 80px;
        }
        .group-info hr {
            border-color: var(--color-border); 
            margin: 15px 0;
        }

        /* === کارت‌های امتیازدهی و اسلایدرها === */
        .criterion { 
            margin-bottom: 25px; 
            padding: 20px; 
            border-radius: 12px; 
            background-color: var(--color-bg-primary);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); 
            border-left: 5px solid var(--color-accent-blue);
            transition: transform 0.2s;
        }
        .criterion:hover {
            transform: translateY(-3px); 
        }
        .criterion-header {
            display: flex;
            align-items: flex-start; 
            margin-bottom: 15px;
        }
        .criterion-header i {
            font-size: 1.5em;
            color: var(--color-accent-blue);
            margin-left: 15px;
            flex-shrink: 0; 
        }
        label { 
            font-weight: 700; 
            color: var(--color-text-light); 
            flex-grow: 1; 
            font-size: 1.1em;
        }
        
        input[type="range"] { 
            width: 100%; 
            height: 14px; 
            -webkit-appearance: none; 
            background: linear-gradient(to right, var(--color-danger) 0%, var(--color-accent-green) 100%); 
            border-radius: 7px; 
            outline: none;
            cursor: grab; 
            box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.4); 
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 32px; 
            height: 32px; 
            border-radius: 50%;
            background: var(--color-accent-green); 
            border: 4px solid var(--color-bg-primary); 
            cursor: grab;
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.9); 
        }
        .range-value { 
            font-weight: 900; 
            color: var(--color-warning); 
            font-size: 1.8em; 
            width: 80px;
            text-align: center;
            flex-shrink: 0;
            margin-left: 15px; 
        }

        .score-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px; 
            font-size: 0.9em;
            color: var(--color-text-muted);
            font-weight: 700;
            padding: 0 2px; 
        }
        .score-display span:first-child {
            transform: translateX(10px); 
        }
        .score-display span:last-child {
            transform: translateX(-10px); 
        }
        
        /* کادر مجموع نمره و دکمه‌ها ... */
        #totalScoreDisplay {
            font-size: 1.8em;
            font-weight: 900;
            background-color: #111111; 
            margin-top: 40px;
            padding: 30px;
            border-radius: 15px; 
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.9);
            border: 2px solid var(--color-accent-green); 
            text-align: center;
            color: var(--color-text-light); 
        }
        #totalScore {
            color: var(--color-accent-green); 
            font-size: 1.4em;
            margin-right: 5px;
            text-shadow: 0 0 10px rgba(46, 204, 113, 0.7); 
        }

        #summary-table {
            width: 100%;
            margin-top: 30px;
            border-collapse: collapse;
            background-color: #111111;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        }
        #summary-table th, #summary-table td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid var(--color-border);
        }
        #summary-table th {
            background-color: var(--color-accent-blue);
            color: white;
            text-align: center;
            font-size: 1.1em;
            font-weight: 700;
        }
        .summary-total-row td {
            font-weight: 900;
            background-color: #333;
            color: var(--color-accent-green);
            font-size: 1.2em;
        }
        .summary-ip-row td {
            font-size: 0.9em;
            color: var(--color-info); 
        }
        
        button { 
            background-color: var(--color-accent-blue); 
            font-weight: 700;
            padding: 18px 30px; 
            border-radius: 10px;
            font-size: 1.3em; 
            border: none;
            color: white;
            width: 100%; 
            margin-top: 30px;
            transition: transform 0.2s;
        }
        
        #message, #warningMessage {
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: 700;
            text-align: center;
            display: none;
            color: var(--color-text-light);
        }
        #message { background-color: var(--color-danger); }
        #warningMessage { background-color: var(--color-info); }

        /* =================================
           Media Query: بهینه‌سازی نهایی برای موبایل (زیر ۶۰۰ پیکسل)
           ================================= */
        @media (max-width: 600px) {
            
            body {
                align-items: flex-start; 
                padding: 10px 0; 
                min-height: auto; 
            }
            
            /* **محدود کردن عرض کانتینر در موبایل برای عدم نمایش تمام صفحه** */
            .container {
                padding: 15px 15px; 
                width: 90%; /* عرض ۹۰ درصد */
                max-width: 400px; /* حداکثر عرض ۴۰۰ پیکسل برای کوچک‌تر شدن */
                margin: 0 auto; /* قرارگیری در وسط صفحه */
            }
            
            /* **فشرده‌تر کردن عناصر** */
            h1 { 
                font-size: 1.7em; 
                margin-bottom: 15px;
            }
            label {
                font-size: 0.9em;
            }
            
            /* **فیلدها و کادر اطلاعات** */
            .group-info {
                padding: 12px;
                margin-bottom: 20px;
            }
            .group-info input[type="text"], .group-info textarea {
                padding: 10px; 
            }

            /* **کارت‌های امتیازدهی** */
            .criterion {
                padding: 12px;
                margin-bottom: 15px;
            }
            .range-value {
                font-size: 1.3em; 
                width: 50px; 
            }
            
            button {
                font-size: 1.05em;
                padding: 12px;
            }
            
            .criterion-header i {
                font-size: 1.2em;
                margin-left: 10px;
            }
            
            /* **بهینه‌سازی اسلایدر و اعداد زیر آن** */
            input[type="range"]::-webkit-slider-thumb {
                width: 25px; 
                height: 25px; 
                border: 3px solid var(--color-bg-primary);
            }
            .score-display {
                font-size: 0.8em;
                padding: 0;
            }
            .score-display span {
                transform: none !important;
            }
        }
    </style>
</head>
<body>
    
    <div class="container">
        
        <section id="welcome-section">
            <h1>سامانه ارزیابی نمرات آزمایشگاه <i class="fas fa-satellite-dish"></i></h1>
            <p>این پنل امتیازدهی مدرن برای **کلاس ۱۰۵۱ و درس آزمایشگاه** طراحی شده است. لطفا اطلاعات را با دقت وارد کنید.</p>
            <p style="color:var(--color-accent-blue);">تهیه کننده سایت : امیرعلی نظافت</p>
            <button id="startButton">شروع ارزیابی</button>
        </section>

        <section id="score-form-section" style="display: none;">
            <h1>ثبت نمره و امتیازات <i class="fas fa-fingerprint"></i></h1>
            
            <form id="scoreForm"> 
                
                <input type="hidden" name="access_key" value="755e29bf-7f1e-45af-96ad-eecec91934e9">
                <input type="hidden" name="_subject" value="گزارش ارزیابی جدید آزمایشگاه">
                <input type="hidden" name="_ip" value="true"> 

                <div class="group-info">
                    
                    <label for="subjectGroupName"><i class="fas fa-users"></i> نام اعضای گروه آزمایش‌دهنده (فقط فارسی):</label>
                    <input type="text" id="subjectGroupName" name="گروه_آزمایش_دهنده" placeholder="اعضا را با ویرگول یا فاصله جدا کنید" required>
                    <hr>

                    <label for="evaluatorName"><i class="fas fa-user-tie"></i> نام شما (ارزیابی‌کننده - فقط فارسی):</label>
                    <input type="text" id="evaluatorName" name="ارزیابی_کننده" placeholder="نام و نام خانوادگی خودتان را وارد کنید" required>
                </div>
                
                
                <div class="criterion">
                    <div class="criterion-header">
                        <i class="fas fa-book"></i>
                        <label for="c1">۱. مفید بودن موضوع را چگونه ارزیابی می کنید؟</label>
                        <div class="range-value" id="v1">۰.۵۰</div>
                    </div>
                    <input type="range" id="c1" name="نمره_۱_مفید_بودن_موضوع" min="0" max="1" step="0.25" value="0.5">
                    <div class="score-display"><span>۰</span><span>۰.۲۵</span><span style="font-weight: 700;">۰.۵۰</span><span>۰.۷۵</span><span>۱</span></div>
                </div>
                
                <div class="criterion">
                    <div class="criterion-header">
                        <i class="fas fa-mask"></i>
                        <label for="c2">۲. نحوه ارائه را چگونه ارزیابی می کنید؟</label>
                        <div class="range-value" id="v2">۰.۵۰</div>
                    </div>
                    <input type="range" id="c2" name="نمره_۲_نحوه_ارائه" min="0" max="1" step="0.25" value="0.5">
                    <div class="score-display"><span>۰</span><span>۰.۲۵</span><span style="font-weight: 700;">۰.۵۰</span><span>۰.۷۵</span><span>۱</span></div>
                </div>

                <div class="criterion">
                    <div class="criterion-header">
                        <i class="fas fa-cogs"></i>
                        <label for="c3">۳. نمره تسلط آنها بر موضوع از نظر شما چند است؟</label>
                        <div class="range-value" id="v3">۰.۵۰</div>
                    </div>
                    <input type="range" id="c3" name="نمره_۳_تسلط_بر_موضوع" min="0" max="1" step="0.25" value="0.5">
                    <div class="score-display"><span>۰</span><span>۰.۲۵</span><span style="font-weight: 700;">۰.۵۰</span><span>۰.۷۵</span><span>۱</span></div>
                </div>
                
                <div class="criterion">
                    <div class="criterion-header">
                        <i class="fas fa-bullhorn"></i>
                        <label for="c4">۴. مدیرت زمان آنها چه نمره ای میگیرد؟</label>
                        <div class="range-value" id="v4">۰.۵۰</div>
                    </div>
                    <input type="range" id="c4" name="نمره_۴_مدیریت_زمان" min="0" max="1" step="0.25" value="0.5">
                    <div class="score-display"><span>۰</span><span>۰.۲۵</span><span style="font-weight: 700;">۰.۵۰</span><span>۰.۷۵</span><span>۱</span></div>
                </div>
                
                <div class="criterion">
                    <div class="criterion-header">
                        <i class="fas fa-lightbulb"></i>
                        <label for="c5">۵. چه نمره ای برای استفاده از ابزار ها در نظر می گیرید؟</label>
                        <div class="range-value" id="v5">۰.۵۰</div>
                    </div>
                    <input type="range" id="c5" name="نمره_۵_استفاده_از_ابزار" min="0" max="1" step="0.25" value="0.5">
                    <div class="score-display"><span>۰</span><span>۰.۲۵</span><span style="font-weight: 700;">۰.۵۰</span><span>۰.۷۵</span><span>۱</span></div>
                </div>
                
                <div class="group-info">
                    <label for="confidentialNotes"><i class="fas fa-sticky-note"></i> نظر و انتقاد خود را راجع به گروه وارد کنید (اختیاری):</label>
                    <textarea id="confidentialNotes" name="نظر_انتقاد" placeholder="نظر خود را بنویسید..."></textarea>
                </div>

                <div id="totalScoreDisplay">
                    <p style="margin: 0;">مجموع نمره نهایی: <span id="totalScore">۲.۵۰</span> از ۵</p>
                    <input type="hidden" id="finalTotalScore" name="نمره_نهایی_کل" value="2.50">
                    <input type="hidden" name="Sender" value="امیرعلی">
                </div>
                
                <div id="warningMessage"></div>
                <button type="submit" id="submitButton">ثبت و ارسال نهایی امتیازات <i class="fas fa-paper-plane"></i></button>
            </form>
            <div id="message" style="display: none;"></div>
        </section>

        <section id="success-section" class="success-message-style" style="display: none;">
            <h1>✅ ارسال موفقیت‌آمیز</h1>
            <p id="successGroupMessage" style="font-size:1.3em;">امتیاز شما با موفقیت ثبت و به سیستم ارسال شد.</p>
            
            <table id="summary-table">
                <thead>
                    <tr>
                        <th colspan="2"><i class="fas fa-chart-bar"></i> خلاصه ارزیابی</th>
                    </tr>
                </thead>

                <tbody id="summary-body">
                    </tbody>
            </table>
            
            <button id="nextGroupButton" style="width: auto; padding: 15px 30px; margin-top: 30px; background-color: var(--color-accent-green); box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);">ارزیابی گروه بعدی <i class="fas fa-redo-alt"></i></button>
            <p style="color:var(--color-text-muted); margin-top: 30px;">سپاس از همکاری حرفه‌ای شما.</p>
        </section>

    </div>

    <script>
        /* =================================
           JavaScript: مدیریت عملکرد و ارسال داده (Web3Forms)
           ================================= */
        const startButton = document.getElementById('startButton');
        const welcomeSection = document.getElementById('welcome-section');
        const scoreFormSection = document.getElementById('score-form-section');
        const successSection = document.getElementById('success-section');
        const nextGroupButton = document.getElementById('nextGroupButton');
        const form = document.getElementById('scoreForm');
        const submitButton = document.getElementById('submitButton');
        
        // عناصر فرم
        const ranges = [1, 2, 3, 4, 5].map(i => document.getElementById('c' + i));
        const values = [1, 2, 3, 4, 5].map(i => document.getElementById('v' + i));
        const totalScoreElement = document.getElementById('totalScore');
        const finalTotalScoreInput = document.getElementById('finalTotalScore');
        const subjectGroupNameInput = document.getElementById('subjectGroupName');
        const evaluatorNameInput = document.getElementById('evaluatorName');
        const confidentialNotesInput = document.getElementById('confidentialNotes'); 
        const successGroupMessage = document.getElementById('successGroupMessage');
        const messageElement = document.getElementById('message');
        const warningMessageElement = document.getElementById('warningMessage');
        const summaryBody = document.getElementById('summary-body');
        
        // نام معیارها برای خلاصه گزارش
        const criterionNames = [
            'مفید بودن موضوع', 'نحوه ارائه', 'تسلط بر موضوع', 'مدیریت زمان', 'استفاده از ابزار ها'
        ];
        
        // متغیرهای CSS
        const colorDanger = getComputedStyle(document.documentElement).getPropertyValue('--color-danger').trim();
        const colorWarning = getComputedStyle(document.documentElement).getPropertyValue('--color-warning').trim();
        const colorAccentGreen = getComputedStyle(document.documentElement).getPropertyValue('--color-accent-green').trim();
        const colorTextLight = getComputedStyle(document.documentElement).getPropertyValue('--color-text-light').trim();

        const LOCAL_STORAGE_KEY = 'lab_scoring_data_v5'; 
        
        // --- توابع کمکی ---
        
        // ۱. اعتبارسنجی فارسی
        function isPersianOnly(str) {
            const persianRegex = /^[\u0600-\u06FF\s\d\u06F0-\u06F9,،\u200C]+$/; 
            return persianRegex.test(str.trim());
        }

        // ۲. ذخیره وضعیت فعلی فرم
        function saveState() {
            const state = {
                groupName: subjectGroupNameInput.value,
                evaluatorName: evaluatorNameInput.value,
                confidentialNotes: confidentialNotesInput.value,
                scores: ranges.map(r => r.value)
            };
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state));
        }

        // ۳. بازیابی وضعیت فرم
        function loadState() {
            const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedState) {
                const state = JSON.parse(savedState);
                
                if (state.evaluatorName) {
                    evaluatorNameInput.value = state.evaluatorName;
                }
                if (state.confidentialNotes) {
                    confidentialNotesInput.value = state.confidentialNotes;
                }
                if (state.groupName) {
                    subjectGroupNameInput.value = state.groupName;
                }
                
                if (state.scores && state.scores.length === ranges.length) {
                    state.scores.forEach((score, index) => {
                        ranges[index].value = score;
                    });
                }
                updateScores(); 
            }
        }
        
        // ۴. به‌روزرسانی نمرات و مجموع
        function updateScores() {
            let total = 0;
            ranges.forEach((range, index) => {
                const score = parseFloat(range.value);
                values[index].textContent = score.toFixed(2); 
                total += score;

                if (score < 0.3) {
                    values[index].style.color = colorDanger; 
                } else if (score < 0.7) {
                    values[index].style.color = colorWarning; 
                } else {
                    values[index].style.color = colorAccentGreen; 
                }
            });
            
            const finalTotal = total.toFixed(2);
            totalScoreElement.textContent = finalTotal; 
            finalTotalScoreInput.value = finalTotal; 
            
            if (total < 2.5) {
                totalScoreElement.style.color = colorDanger; 
                totalScoreElement.style.textShadow = `0 0 10px rgba(231, 76, 60, 0.7)`; 
            } else if (total < 4.0) {
                totalScoreElement.style.color = colorWarning; 
                totalScoreElement.style.textShadow = `0 0 10px rgba(241, 196, 15, 0.7)`; 
            } else {
                totalScoreElement.style.color = colorAccentGreen; 
                totalScoreElement.style.textShadow = `0 0 10px rgba(46, 204, 113, 0.7)`; 
            }
            
            saveState();
        }

        // ⭐ تابع جدید: دریافت IP کاربر از یک سرویس خارجی
        async function fetchUserIP() {
            try {
                // استفاده از سرویس رایگان ipify برای دریافت IP عمومی
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip || 'نامشخص';
            } catch (error) {
                console.error("Error fetching IP:", error);
                return 'خطا در دریافت IP';
            }
        }


        // ۵. ایجاد جدول خلاصه گزارش (با اضافه کردن IP)
        function buildSummary(scores, total, notes, groupName, ipAddress) {
            let html = '';
            criterionNames.forEach((name, index) => {
                html += `
                    <tr>
                        <td style="font-weight: 700; color: ${colorTextLight};">${name}</td>
                        <td style="font-weight: 900; color: ${colorAccentGreen}; width: 25%; text-align: center;">${scores[index].toFixed(2)}</td>
                    </tr>
                `;
            });
            
             html += `
                <tr class="summary-total-row">
                    <td>مجموع نهایی</td>
                    <td style="text-align: center;">${total.toFixed(2)} / ۵</td>
                </tr>
            `;

            // ⭐ اضافه کردن ردیف IP به خلاصه گزارش
            html += `
                <tr class="summary-ip-row">
                    <td style="font-weight: 700; color: var(--color-info);"><i class="fas fa-globe"></i> آدرس IP ارسال</td>
                    <td style="font-weight: 700; color: var(--color-info); text-align: center; direction: ltr;">${ipAddress}</td>
                </tr>
            `;
            
            if (notes) {
                 html += `
                    <tr>
                        <td style="font-weight: 700; color: ${colorTextLight};">نظر شما راجع به گروه</td>
                        <td style="width: 25%; font-size: 0.9em;">${notes}</td>
                    </tr>
                `;
            }

            summaryBody.innerHTML = html;
        }


        // --- مدیریت رویدادها ---

        // شروع و بارگذاری اولیه
        startButton.addEventListener('click', () => {
            welcomeSection.style.display = 'none';
            scoreFormSection.style.display = 'block';
            loadState(); 
        });
        
        // گوش دادن به تغییرات فیلدها برای ذخیره موقت
        ranges.forEach(range => range.addEventListener('input', updateScores));
        subjectGroupNameInput.addEventListener('input', saveState);
        evaluatorNameInput.addEventListener('input', saveState);
        confidentialNotesInput.addEventListener('input', saveState);

        // مدیریت ارسال فرم
        form.addEventListener('submit', function(e) {
            e.preventDefault(); 
            
            const groupName = subjectGroupNameInput.value.trim();
            const evaluatorName = evaluatorNameInput.value.trim();
            const scoresArray = ranges.map(r => parseFloat(r.value));
            
            messageElement.style.display = 'none';
            warningMessageElement.style.display = 'none';

            // اعتبارسنجی ۱: پر بودن فیلدهای ضروری
            if (!groupName || !evaluatorName) {
                messageElement.style.display = 'block';
                messageElement.textContent = '⛔️ لطفاً نام گروه و نام خودتان را به طور کامل وارد کنید.';
                return;
            }
            
            // اعتبارسنجی ۲: فقط فارسی بودن نام‌ها
            if (!isPersianOnly(groupName) || !isPersianOnly(evaluatorName)) {
                messageElement.style.display = 'block';
                messageElement.textContent = '⛔️ لطفاً فقط از حروف فارسی، اعداد فارسی، فاصله و ویرگول برای وارد کردن نام‌ها استفاده کنید.';
                return;
            }
            
            // اعتبارسنجی ۳: هشدار نمره‌دهی شدید 
            const allZero = scoresArray.every(r => r === 0.0);
            const allOne = scoresArray.every(r => r === 1.0);
            
            if (allZero || allOne) {
                if (submitButton.dataset.warned === 'true') {
                    processSubmissionFinal();
                    return;
                }
                
                warningMessageElement.style.display = 'block';
                warningMessageElement.innerHTML = `⚠️ **هشدار نمره‌دهی شدید:** به نظر می‌رسد تمام نمرات ${allZero ? 'صفر' : 'یک'} هستند. اگر از این ارزیابی مطمئن هستید، دوباره دکمه **ثبت نهایی** را بزنید.`;
                submitButton.dataset.warned = 'true'; 
                return;
            }
            
            processSubmissionFinal();
        });

        // تابع نهایی ارسال (با دریافت و نمایش IP)
        async function processSubmissionFinal() { // تابع به حالت async تغییر یافت
            const groupName = subjectGroupNameInput.value.trim();
            const confidentialNotes = confidentialNotesInput.value.trim();
            const totalScore = parseFloat(finalTotalScoreInput.value);
            const scoresArray = ranges.map(r => parseFloat(r.value));
            
            // ⭐ مرحله ۱: دریافت IP کاربر
            const userIP = await fetchUserIP(); 
            
            // نمایش دکمه در حال ارسال
            submitButton.disabled = true;
            submitButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> در حال ارسال...`;

            // ساخت خلاصه گزارش قبل از ارسال واقعی (شامل IP)
            buildSummary(scoresArray, totalScore, confidentialNotes, groupName, userIP);

            // ایجاد آبجکت FormData از فرم
            const formData = new FormData(form);
            const object = {};
            formData.forEach((value, key) => {
                object[key] = value;
            });
            // افزودن IP به داده‌های ارسالی به Web3Forms (فقط برای اطمینان، چون فیلد _ip هم هست)
            object['IP_ارسال_کننده'] = userIP; 


            // استفاده از Fetch API برای ارسال داده به Web3Forms در پس‌زمینه
            fetch("https://api.web3forms.com/submit", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                },
                body: JSON.stringify(object)
            })
            .then(async (response) => {
                let json = await response.json();
                if (response.status == 200 && json.success) {
                    // ارسال موفقیت‌آمیز
                    
                    // جابجایی به بخش ثبت موفق
                    scoreFormSection.style.display = 'none';
                    successGroupMessage.innerHTML = `امتیاز شما برای گروه **${groupName}** با موفقیت ثبت و به سیستم ارسال شد.`;
                    successSection.style.display = 'block';
                    
                    // پاکسازی Local Storage
                    submitButton.dataset.warned = 'false';
                    localStorage.removeItem(LOCAL_STORAGE_KEY);
                    
                } else {
                    // نمایش پیام خطا در صورت عدم موفقیت در ارسال
                    messageElement.style.display = 'block';
                    messageElement.textContent = '❌ خطا در ارسال اطلاعات به سرور. لطفا مجددا تلاش کنید.';
                }
            })
            .catch(error => {
                // خطای شبکه
                messageElement.style.display = 'block';
                messageElement.textContent = `❌ خطای اتصال به شبکه: ${error.message}`;
            })
            .finally(() => {
                // در هر صورت دکمه را فعال کنید
                submitButton.disabled = false;
                submitButton.innerHTML = `ثبت و ارسال نهایی امتیازات <i class="fas fa-paper-plane"></i>`;
            });
        }
        
        // مدیریت دکمه ارزیابی گروه بعدی
        nextGroupButton.addEventListener('click', () => {
            successSection.style.display = 'none';
            scoreFormSection.style.display = 'block';
            
            // پاک کردن فیلدهای گروه
            subjectGroupNameInput.value = '';
            confidentialNotesInput.value = '';

            // بازنشانی اسلایدرها به مقدار اولیه (0.5) و به‌روزرسانی نمایش
            ranges.forEach(r => r.value = parseFloat(r.min) + (parseFloat(r.max) - parseFloat(r.min)) / 2);
            updateScores();
            
            // تمرکز روی فیلد نام گروه
            subjectGroupNameInput.focus();
        });

        // اجرای اولیه برای نمایش نمرات پیش‌فرض
        updateScores(); 
    </script>
</body>
</html>
